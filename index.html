<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pastelaria da Nathy — Vendas</title>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#fff0f6; --card:#fff; --accent:#d63384; --btn:#ff4da6; --muted:#666;
  }
  body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);-webkit-font-smoothing:antialiased;}
  .app{max-width:520px;margin:0 auto;padding:14px}
  h1{text-align:center;color:var(--accent);margin:6px 0 12px;font-size:22px}
  .card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 6px 18px rgba(214,51,132,0.06)}
  label{display:block;font-weight:700;margin:8px 0 6px;font-size:14px}
  input[type="text"],input[type="number"],select,textarea,input[type="date"]{
    width:100%;padding:12px;border-radius:10px;border:1px solid #ffd6eb;font-size:16px;box-sizing:border-box;
  }
  textarea{min-height:64px;resize:none}
  .row{display:flex;gap:8px}
  .col{flex:1}
  .btn{background:var(--btn);color:#fff;border:0;padding:12px;border-radius:12px;font-weight:800;font-size:16px;cursor:pointer}
  .btn.secondary{background:#ffb3d9;color:#fff}
  .btn.ghost{background:transparent;border:2px solid #ffd6eb;color:var(--accent)}
  .small{font-size:13px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
  th,td{padding:8px;border-bottom:1px solid #fff2f7;text-align:left}
  th{background:#ffd6eb;color:#fff}
  .actions button{margin-right:6px;padding:6px 8px;border-radius:8px;border:0;cursor:pointer}
  .edit{background:#28a745;color:#fff}
  .del{background:#c8234f;color:#fff}
  .totals{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .box{flex:1;background:#fff;padding:10px;border-radius:10px;text-align:center;font-weight:800}
  .vendorTotals{margin-top:8px}
  .filterRow{display:flex;gap:8px;align-items:center;margin-top:6px}
  @media (max-width:420px){ .row, .filterRow{flex-direction:column} .btn{font-size:18px} input,select{font-size:18px;padding:14px} }
</style>
</head>
<body>
  <div class="app">
    <h1>Pastelaria da Nathy</h1>

    <!-- Form (add/edit) -->
    <div class="card" id="formCard">
      <label>Data</label>
      <input type="date" id="inputDate">

      <label>Vendedor</label>
      <select id="inputVendedor">
        <option>Nathy</option>
        <option>Jean</option>
        <option>Juan</option>
      </select>

      <label>Cliente</label>
      <input type="text" id="inputCliente" placeholder="Digite o nome do cliente">

      <label>Item</label>
      <select id="inputItem">
        <option>Carne com Cheddar</option>
        <option>Frango com Cheddar</option>
        <option>Carne com Requeijão</option>
        <option>Frango com Requeijão</option>
      </select>

      <div class="row" style="margin-top:6px">
        <div class="col">
          <label>Quantidade</label>
          <input type="number" id="inputQtd" min="1" value="1">
        </div>
        <div class="col">
          <label>Com refri?</label>
          <select id="inputRefri">
            <option value="0">Não</option>
            <option value="1">Sim (+R$2)</option>
          </select>
        </div>
      </div>

      <label style="margin-top:6px">Pago?</label>
      <select id="inputPago">
        <option value="1">Sim</option>
        <option value="0">Não</option>
      </select>

      <label>Observação</label>
      <textarea id="inputObs" placeholder="Ex: sem cebola"></textarea>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="saveBtn">Adicionar</button>
        <button class="btn secondary" id="clearBtn">Limpar</button>
      </div>

      <input type="hidden" id="editId" value="">
      <p class="small" style="margin-top:8px">Pastel R$10, Refri +R$2</p>
    </div>

    <!-- Filters + actions -->
    <div class="card">
      <div class="filterRow">
        <div style="flex:1">
          <label>Filtrar por data</label>
          <input type="date" id="filterDate">
        </div>

        <div style="width:150px">
          <label>Vendedor</label>
          <select id="filterVendor">
            <option value="">Todos</option>
            <option>Nathy</option>
            <option>Jean</option>
            <option>Juan</option>
          </select>
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" onclick="loadSales()">Atualizar</button>
        <button class="btn ghost" onclick="exportCSV()">Exportar CSV</button>
      </div>
    </div>

    <!-- Table + totals -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">Vendas</h3>
      <div id="tableWrap"></div>

      <div class="totals">
        <div class="box">Recebido<br><span id="totalPaid">R$ 0,00</span></div>
        <div class="box">Pendentes<br><span id="totalPending">R$ 0,00</span></div>
        <div class="box">Geral<br><span id="totalAll">R$ 0,00</span></div>
      </div>

      <div class="vendorTotals card" style="margin-top:10px;background:transparent;padding:0">
        <div style="display:flex;gap:8px">
          <div style="flex:1;background:#fff;padding:8px;border-radius:10px">Nathy: <span id="vtNathy">R$ 0,00</span></div>
          <div style="flex:1;background:#fff;padding:8px;border-radius:10px">Jean: <span id="vtJean">R$ 0,00</span></div>
          <div style="flex:1;background:#fff;padding:8px;border-radius:10px">Juan: <span id="vtJuan">R$ 0,00</span></div>
        </div>
      </div>
    </div>

  </div>

<script>
/* ------------- CONFIG SUPABASE ------------- */
/* Seus dados (já configurados) */
const SUPABASE_URL = "https://kvdlwnlviedisywdykty.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2ZGx3bmx2aWVkaXN5d2R5a3R5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNjQ4MDcsImV4cCI6MjA3ODc0MDgwN30.pWBQRyjFIWbnDzX0tQhAuyYUwEfmyK6HPm5jzUlpp3Q";
const supabase = supabaseJs.createClient ? supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
// compatibility for different cdn names

/* ------------- UTIL ------------- */
function formatBRL(n){ return 'R$ ' + Number(n || 0).toFixed(2).replace('.',','); }
function q(sel){ return document.querySelector(sel) }
function todayISO(){ return new Date().toISOString().slice(0,10) }

/* ------------- INIT UI ------------- */
q('#filterDate').value = todayISO();
q('#inputDate').value = todayISO();

/* ------------- ADD / UPDATE ------------- */
q('#saveBtn').addEventListener('click', async ()=>{
  const id = q('#editId').value;
  const vendedor = q('#inputVendedor').value;
  const cliente = q('#inputCliente').value.trim();
  const item = q('#inputItem').value;
  const quantidade = Math.max(1, parseInt(q('#inputQtd').value) || 1);
  const com_refri = q('#inputRefri').value === '1';
  const pago = q('#inputPago').value === '1';
  const obs = q('#inputObs').value.trim();
  const valor = (10 * quantidade) + (com_refri ? 2 : 0);

  if(!cliente){ alert('Preencha o nome do cliente'); return; }

  if(id){
    // update
    const { error } = await supabase.from('vendas').update({
      vendedor, cliente, item, quantidade, com_refri, pago, valor, obs
    }).eq('id', id);
    if(error){ alert('Erro ao atualizar: ' + error.message); return; }
    q('#editId').value = '';
    q('#saveBtn').innerText = 'Adicionar';
  } else {
    // insert
    const { error } = await supabase.from('vendas').insert([{
      vendedor, cliente, item, quantidade, com_refri, pago, valor
    }]);
    if(error){ alert('Erro ao salvar: ' + error.message); return; }
  }

  clearForm();
  await loadSales();
});

/* clear button */
q('#clearBtn').addEventListener('click', clearForm);
function clearForm(){
  q('#inputCliente').value = '';
  q('#inputQtd').value = '1';
  q('#inputRefri').value = '0';
  q('#inputPago').value = '1';
  q('#inputObs').value = '';
  q('#editId').value = '';
  q('#saveBtn').innerText = 'Adicionar';
  q('#inputDate').value = todayISO();
}

/* ------------- LOAD / RENDER ------------- */
async function loadSales(){
  const date = q('#filterDate').value;
  const vendor = q('#filterVendor').value;

  // build query: filter by date (compare date part of timestamp)
  let query = supabase.from('vendas').select('*').order('data', { ascending: false });
  // filter by date: use range from date 00:00 to date 23:59:59
  if(date){
    const from = new Date(date + 'T00:00:00').toISOString();
    const to = new Date(date + 'T23:59:59').toISOString();
    query = query.gte('data', from).lte('data', to);
  }
  if(vendor) query = query.eq('vendedor', vendor);

  const { data, error } = await query;
  if(error){ console.error(error); alert('Erro ao carregar vendas: ' + error.message); return; }

  renderTable(data || []);
  renderTotals(data || []);
}

function renderTable(rows){
  if(!rows) rows = [];
  let html = `<table><thead><tr>
    <th>Hora</th><th>Vendedor</th><th>Cliente</th><th>Item</th><th>Qtd</th><th>Refri</th><th>Pago</th><th>Valor</th><th></th>
  </tr></thead><tbody>`;
  rows.forEach(r=>{
    const time = new Date(r.data).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    html += `<tr>
      <td>${time}</td>
      <td>${escapeHtml(r.vendedor)}</td>
      <td>${escapeHtml(r.cliente)}</td>
      <td>${escapeHtml(r.item)}</td>
      <td style="text-align:center">${r.quantidade}</td>
      <td style="text-align:center">${r.com_refri ? 'Sim' : 'Não'}</td>
      <td style="text-align:center">${r.pago ? 'Sim' : 'Não'}</td>
      <td style="text-align:right">${formatBRL(r.valor)}</td>
      <td style="text-align:center" class="actions">
        <button class="edit" onclick="startEdit('${r.id}')">Editar</button>
        <button class="del" onclick="deleteSale('${r.id}')">Excluir</button>
      </td>
    </tr>`;
  });
  html += `</tbody></table>`;
  q('#tableWrap').innerHTML = html;
}

/* ------------- TOTALS ------------- */
function renderTotals(rows){
  let totPaid=0, totPend=0, totAll=0;
  const perVendor = { Nathy:0, Jean:0, Juan:0 };

  rows.forEach(r=>{
    const v = Number(r.valor || 0);
    totAll += v;
    if(r.pago) totPaid += v; else totPend += v;
    if(perVendor[r.vendedor]===undefined) perVendor[r.vendedor]=0;
    perVendor[r.vendedor] += v;
  });

  q('#totalPaid').innerText = formatBRL(totPaid);
  q('#totalPending').innerText = formatBRL(totPend);
  q('#totalAll').innerText = formatBRL(totAll);

  q('#vtNathy').innerText = formatBRL(perVendor.Nathy || 0);
  q('#vtJean').innerText = formatBRL(perVendor.Jean || 0);
  q('#vtJuan').innerText = formatBRL(perVendor.Juan || 0);
}

/* ------------- EDIT / DELETE ------------- */
async function startEdit(id){
  // load single
  const { data, error } = await supabase.from('vendas').select('*').eq('id', id).single();
  if(error){ alert('Erro ao buscar venda: ' + error.message); return; }
  const r = data;
  q('#inputDate').value = (new Date(r.data)).toISOString().slice(0,10);
  q('#inputVendedor').value = r.vendedor;
  q('#inputCliente').value = r.cliente;
  q('#inputItem').value = r.item;
  q('#inputQtd').value = r.quantidade;
  q('#inputRefri').value = r.com_refri ? '1' : '0';
  q('#inputPago').value = r.pago ? '1' : '0';
  q('#inputObs').value = r.obs || '';
  q('#editId').value = r.id;
  q('#saveBtn').innerText = 'Salvar alteração';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function deleteSale(id){
  if(!confirm('Excluir essa venda?')) return;
  const { error } = await supabase.from('vendas').delete().eq('id', id);
  if(error){ alert('Erro ao excluir: ' + error.message); return; }
  await loadSales();
}

/* ------------- EXPORT CSV ------------- */
async function exportCSV(){
  // export currently filtered rows
  const date = q('#filterDate').value;
  const vendor = q('#filterVendor').value;
  let query = supabase.from('vendas').select('*').order('data',{ascending:false});
  if(date){
    const from = new Date(date + 'T00:00:00').toISOString();
    const to = new Date(date + 'T23:59:59').toISOString();
    query = query.gte('data', from).lte('data', to);
  }
  if(vendor) query = query.eq('vendedor', vendor);
  const { data, error } = await query;
  if(error){ alert('Erro ao exportar: '+error.message); return; }
  if(!data || data.length===0){ alert('Nenhum registro para exportar'); return; }

  const header = ['id','data','vendedor','cliente','item','quantidade','com_refri','pago','valor','obs'];
  const lines = [header.join(',')];
  data.forEach(r=>{
    const line = [
      `"${r.id}"`,
      `"${r.data}"`,
      `"${(r.vendedor||'').replace(/"/g,'""')}"`,
      `"${(r.cliente||'').replace(/"/g,'""')}"`,
      `"${(r.item||'').replace(/"/g,'""')}"`,
      r.quantidade,
      r.com_refri ? 1 : 0,
      r.pago ? 1 : 0,
      r.valor,
      `"${(r.obs||'').replace(/"/g,'""')}"`
    ];
    lines.push(line.join(','));
  });
  const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `vendas_${date || 'all'}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

/* ------------- helpers ------------- */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ------------- start ------------- */
window.loadSales = loadSales;
document.addEventListener('DOMContentLoaded', ()=>{ loadSales(); });

</script>
</body>
</html>