<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pastelaria da Nathy — Pedidos</title>

<!-- Supabase JS (UMD) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.34.0/dist/umd/supabase.min.js"></script>

<style>
  :root{
    --bg:#fff0f6; --card:#fff; --accent:#d63384; --btn:#ff4da6; --muted:#666;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);-webkit-font-smoothing:antialiased;}
  .app{max-width:520px;margin:0 auto;padding:14px}
  h1{text-align:center;color:var(--accent);margin:10px 0 14px;font-size:22px}
  .card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 6px 18px rgba(214,51,132,0.06)}
  label{display:block;font-weight:700;margin:8px 0 6px;font-size:14px}
  input[type="text"],input[type="number"],select,textarea,input[type="date"]{
    width:100%;padding:12px;border-radius:10px;border:1px solid #ffd6eb;font-size:16px;box-sizing:border-box;
  }
  textarea{min-height:64px;resize:none}
  .row{display:flex;gap:8px}
  .col{flex:1}
  .btn{background:var(--btn);color:#fff;border:0;padding:12px;border-radius:12px;font-weight:800;font-size:16px;cursor:pointer}
  .btn.secondary{background:#ffb3d9;color:#fff}
  .btn.ghost{background:transparent;border:2px solid #ffd6eb;color:var(--accent)}
  .small{font-size:13px;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
  th,td{padding:8px;border-bottom:1px solid #fff2f7;text-align:left}
  th{background:#ffd6eb;color:#fff}
  .actions button{margin-right:6px;padding:6px 8px;border-radius:8px;border:0;cursor:pointer}
  .edit{background:#28a745;color:#fff}
  .del{background:#c8234f;color:#fff}
  .totals{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .box{flex:1;background:#fff;padding:10px;border-radius:10px;text-align:center;font-weight:800}
  .vendorTotals{margin-top:8px}
  .filterRow{display:flex;gap:8px;align-items:center;margin-top:6px}
  @media (max-width:420px){ .row, .filterRow{flex-direction:column} .btn{font-size:18px} input,select{font-size:18px;padding:14px} }
</style>
</head>
<body>
  <div class="app">

    <h1>Pastelaria da Nathy</h1>

    <!-- LOGIN -->
    <div id="loginCard" class="card">
      <label>Usuário</label>
      <select id="loginUser">
        <option>Nathy</option>
        <option>Jean</option>
        <option>Juan</option>
      </select>

      <label>PIN</label>
      <input id="loginPin" placeholder="Digite o PIN (ex: 1234)" type="password"/>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="btnLogin">Entrar</button>
        <button class="btn secondary" id="btnClearLocal">Limpar local</button>
      </div>

      <p class="small" style="margin-top:8px">PIN padrão: <b>1234</b></p>
    </div>

    <!-- APP -->
    <div id="appUI" style="display:none">

      <!-- Formulário de pedido -->
      <div class="card" id="formCard">
        <label>Data</label>
        <input type="date" id="inputDate">

        <label>Vendedor</label>
        <select id="inputVendedor">
          <option>Nathy</option>
          <option>Jean</option>
          <option>Juan</option>
        </select>

        <label>Cliente</label>
        <input type="text" id="inputCliente" placeholder="Nome do cliente" />

        <label>Item</label>
        <select id="inputItem">
          <option>Carne com Cheddar</option>
          <option>Frango com Cheddar</option>
          <option>Carne com Requeijão</option>
          <option>Frango com Requeijão</option>
        </select>

        <div class="row" style="margin-top:6px">
          <div class="col">
            <label>Quantidade</label>
            <input type="number" id="inputQtd" min="1" value="1" />
          </div>
          <div class="col">
            <label>Com refri?</label>
            <select id="inputRefri">
              <option value="0">Não</option>
              <option value="1">Sim (+R$2)</option>
            </select>
          </div>
        </div>

        <label>Pago?</label>
        <select id="inputPago">
          <option value="1">Sim</option>
          <option value="0">Não</option>
        </select>

        <label>Observação</label>
        <textarea id="inputObs" placeholder="Ex: sem cebola, entrega..."></textarea>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="saveBtn">Adicionar</button>
          <button class="btn secondary" id="clearBtn">Limpar</button>
        </div>

        <input type="hidden" id="editId" value="">
        <p class="small" style="margin-top:8px">Pastel R$10 • Refri R$2</p>
      </div>

      <!-- filtros e ações -->
      <div class="card">
        <div class="filterRow">
          <div style="flex:1">
            <label>Filtrar por data</label>
            <input type="date" id="filterDate">
          </div>

          <div style="width:150px">
            <label>Vendedor</label>
            <select id="filterVendor">
              <option value="">Todos</option>
              <option>Nathy</option>
              <option>Jean</option>
              <option>Juan</option>
            </select>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn" id="btnReload">Atualizar</button>
          <button class="btn ghost" id="btnExport">Exportar CSV</button>
          <button class="btn ghost" id="btnLogout">Sair</button>
        </div>
      </div>

      <!-- tabela e totais -->
      <div class="card">
        <h3 style="margin:0 0 8px 0">Vendas</h3>
        <div id="tableWrap"></div>

        <div class="totals">
          <div class="box">Recebido<br><span id="totalPaid">R$ 0,00</span></div>
          <div class="box">Pendentes<br><span id="totalPending">R$ 0,00</span></div>
          <div class="box">Geral<br><span id="totalAll">R$ 0,00</span></div>
        </div>

        <div class="vendorTotals" style="margin-top:10px">
          <div style="display:flex;gap:8px">
            <div style="flex:1;background:#fff;padding:8px;border-radius:10px">Nathy: <span id="vtNathy">R$ 0,00</span></div>
            <div style="flex:1;background:#fff;padding:8px;border-radius:10px">Jean: <span id="vtJean">R$ 0,00</span></div>
            <div style="flex:1;background:#fff;padding:8px;border-radius:10px">Juan: <span id="vtJuan">R$ 0,00</span></div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
/* ================= CONFIG (use seus valores) ================= */
const SUPABASE_URL = "https://kvdlwnlviedisywdykty.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2ZGx3bmx2aWVkaXN5d2R5a3R5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNjQ4MDcsImV4cCI6MjA3ODc0MDgwN30.pWBQRyjFIWbnDzX0tQhAuyYUwEfmyK6HPm5jzUlpp3Q";

/* inicializa supabase */
const supabase = supabaseJs.createClient
  ? supabaseJs.createClient(SUPABASE_URL, SUPABASE_KEY)
  : supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* util */
const $ = (s)=>document.querySelector(s);
const todayISO = ()=> new Date().toISOString().slice(0,10);
const formatBRL = (n)=> 'R$ ' + Number(n||0).toFixed(2).replace('.',',');

/* init UI defaults */
$('#filterDate').value = todayISO();
$('#inputDate').value = todayISO();

/* LOGIN */
$('#btnLogin').addEventListener('click', ()=>{
  const pin = $('#loginPin').value.trim();
  const user = $('#loginUser').value;
  if(pin === '1234'){
    // show app
    $('#loginCard').style.display = 'none';
    $('#appUI').style.display = 'block';
    // default vendedor in form = logged user
    $('#inputVendedor').value = user;
    $('#filterVendor').value = '';
    loadSales();
  } else {
    alert('PIN incorreto');
  }
});

/* clear local storage for debugging (optional) */
$('#btnClearLocal').addEventListener('click', ()=>{
  if(confirm('Remover dados locais (não afeta Supabase)?')) {
    localStorage.clear();
    alert('LocalStorage limpo.');
  }
});

/* LOGOUT */
$('#btnLogout').addEventListener('click', ()=>{
  if(confirm('Sair do app?')) {
    location.reload();
  }
});

/* ADD / UPDATE */
$('#saveBtn').addEventListener('click', async ()=>{
  const id = $('#editId').value || null;
  const vendedor = $('#inputVendedor').value;
  const cliente = $('#inputCliente').value.trim();
  const item = $('#inputItem').value;
  const quantidade = Math.max(1, parseInt($('#inputQtd').value) || 1);
  const com_refri = $('#inputRefri').value === '1';
  const pago = $('#inputPago').value === '1';
  const obs = $('#inputObs').value.trim();
  const data = $('#inputDate').value || todayISO();
  const valor = (10 * quantidade) + (com_refri ? 2 : 0);

  if(!cliente){ alert('Preencha o nome do cliente'); return; }

  if(id){
    // update
    const { error } = await supabase.from('pedidos').update({
      vendedor, cliente, item, quantidade, com_refri, pago, obs, data, valor
    }).eq('id', id);
    if(error){ alert('Erro ao atualizar: ' + error.message); return; }
    $('#editId').value = '';
    $('#saveBtn').innerText = 'Adicionar';
  } else {
    // insert
    const { error } = await supabase.from('pedidos').insert([{
      vendedor, cliente, item, quantidade, com_refri, pago, obs, data, valor
    }]);
    if(error){ alert('Erro ao salvar: ' + error.message); return; }
  }

  clearForm();
  await loadSales();
});

/* clear form */
$('#clearBtn').addEventListener('click', clearForm);
function clearForm(){
  $('#inputCliente').value = '';
  $('#inputQtd').value = '1';
  $('#inputRefri').value = '0';
  $('#inputPago').value = '1';
  $('#inputObs').value = '';
  $('#editId').value = '';
  $('#saveBtn').innerText = 'Adicionar';
  $('#inputDate').value = todayISO();
}

/* load / filter */
$('#btnReload').addEventListener('click', loadSales);
$('#filterDate').addEventListener('change', loadSales);
$('#filterVendor').addEventListener('change', loadSales);
$('#btnExport').addEventListener('click', exportCSV);

async function loadSales(){
  const date = $('#filterDate').value;
  const vendor = $('#filterVendor').value;

  // build query
  let q = supabase.from('pedidos').select('*').order('data',{ascending:false});
  if(date){
    // filter by date field equality (data stored as text/date in 'YYYY-MM-DD')
    q = q.eq('data', date);
  }
  if(vendor) q = q.eq('vendedor', vendor);

  const { data, error } = await q;
  if(error){ console.error(error); alert('Erro ao carregar: ' + error.message); return; }

  renderTable(data || []);
  renderTotals(data || []);
}

/* render table */
function renderTable(rows){
  let html = `<table><thead><tr>
    <th>Hora</th><th>Vendedor</th><th>Cliente</th><th>Item</th><th>Qtd</th><th>Refri</th><th>Pago</th><th style="text-align:right">Valor</th><th></th>
  </tr></thead><tbody>`;

  rows.forEach(r=>{
    // r.data may be date string or timestamp; show time portion if timestamp else empty
    let time = '';
    try {
      const d = new Date(r.criado_em || r.data || r.created_at || r.timestamp);
      if(!isNaN(d)) time = d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    } catch(e){ time = ''; }

    html += `<tr>
      <td>${time}</td>
      <td>${escapeHtml(r.vendedor)}</td>
      <td>${escapeHtml(r.cliente)}</td>
      <td>${escapeHtml(r.item)}</td>
      <td style="text-align:center">${r.quantidade}</td>
      <td style="text-align:center">${r.com_refri ? 'Sim' : 'Não'}</td>
      <td style="text-align:center">${r.pago ? 'Sim' : 'Não'}</td>
      <td style="text-align:right">${formatBRL(r.valor)}</td>
      <td style="text-align:center" class="actions">
        <button class="edit" onclick="startEdit('${r.id}')">Editar</button>
        <button class="del" onclick="deleteSale('${r.id}')">Excluir</button>
      </td>
    </tr>`;
  });

  html += `</tbody></table>`;
  $('#tableWrap').innerHTML = html;
}

/* totals */
function renderTotals(rows){
  let paid=0, pend=0, all=0;
  const per = { Nathy:0, Jean:0, Juan:0 };

  rows.forEach(r=>{
    const v = Number(r.valor||0);
    all += v;
    if(r.pago) paid += v; else pend += v;
    per[r.vendedor] = (per[r.vendedor]||0) + v;
  });

  $('#totalPaid').innerText = formatBRL(paid);
  $('#totalPending').innerText = formatBRL(pend);
  $('#totalAll').innerText = formatBRL(all);

  $('#vtNathy').innerText = formatBRL(per.Nathy || 0);
  $('#vtJean').innerText = formatBRL(per.Jean || 0);
  $('#vtJuan').innerText = formatBRL(per.Juan || 0);
}

/* edit / delete */
async function startEdit(id){
  const { data, error } = await supabase.from('pedidos').select('*').eq('id', id).single();
  if(error){ alert('Erro ao buscar registro: '+error.message); return; }
  const r = data;
  $('#inputDate').value = r.data || todayISO();
  $('#inputVendedor').value = r.vendedor || '';
  $('#inputCliente').value = r.cliente || '';
  $('#inputItem').value = r.item || '';
  $('#inputQtd').value = r.quantidade || 1;
  $('#inputRefri').value = r.com_refri ? '1' : '0';
  $('#inputPago').value = r.pago ? '1' : '0';
  $('#inputObs').value = r.obs || '';
  $('#editId').value = r.id;
  $('#saveBtn').innerText = 'Salvar alteração';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function deleteSale(id){
  if(!confirm('Excluir essa venda?')) return;
  const { error } = await supabase.from('pedidos').delete().eq('id', id);
  if(error){ alert('Erro ao excluir: ' + error.message); return; }
  await loadSales();
}

/* export CSV of current filter */
async function exportCSV(){
  const date = $('#filterDate').value;
  const vendor = $('#filterVendor').value;
  let q = supabase.from('pedidos').select('*').order('data',{ascending:false});
  if(date) q = q.eq('data', date);
  if(vendor) q = q.eq('vendedor', vendor);
  const { data, error } = await q;
  if(error){ alert('Erro: '+error.message); return; }
  if(!data || data.length === 0){ alert('Nenhum registro para exportar'); return; }

  const header = ['id','data','vendedor','cliente','item','quantidade','com_refri','pago','valor','obs'];
  const rows = [header.join(',')];
  data.forEach(r=>{
    const line = [
      `"${r.id}"`,
      `"${r.data}"`,
      `"${(r.vendedor||'').replace(/"/g,'""')}"`,
      `"${(r.cliente||'').replace(/"/g,'""')}"`,
      `"${(r.item||'').replace(/"/g,'""')}"`,
      r.quantidade,
      r.com_refri ? 1 : 0,
      r.pago ? 1 : 0,
      r.valor,
      `"${(r.obs||'').replace(/"/g,'""')}"`
    ];
    rows.push(line.join(','));
  });

  const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `vendas_${date || 'all'}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

/* helper */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* start */
document.addEventListener('DOMContentLoaded', ()=>{ 
  // default filter date today
  $('#filterDate').value = todayISO();
  $('#inputDate').value = todayISO();
  // load today's sales automatically
  loadSales();
});

</script>
</body>
</html>